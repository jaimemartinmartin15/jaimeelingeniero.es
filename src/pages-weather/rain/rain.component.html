<div class="box graphic-scroller" #monthGraphicScroller (scroll)="monthGraphicScrollEvents$.next()">
  <ng-container *ngTemplateOutlet="monthContainer; context: { data: {
      month: selectedMonth > 0 ? selectedMonth -1 : 11,
      year: selectedMonth > 0 ? selectedYear : selectedYear - 1,
      daysArray: previousDaysRainData,
      monthsArray: previousMonthsRainData}}"></ng-container>
  <ng-container *ngTemplateOutlet="monthContainer; context: { data: {
        month: selectedMonth,
        year: selectedYear,
        daysArray: daysRainData,
        monthsArray: monthsRainData}}"></ng-container>
  <ng-container *ngTemplateOutlet="monthContainer; context: {  data: {
          month: selectedMonth < 11 ? selectedMonth + 1 : 0,
          year: selectedMonth < 11 ? selectedYear : selectedYear + 1,
          daysArray: nextDaysRainData,
          monthsArray: nextMonthsRainData}}"></ng-container>
</div>

<div class="box graphic-scroller" #yearGraphicScroller (scroll)="yearGraphicScrollEvents$.next()">
  <ng-container *ngTemplateOutlet="yearContainer; context: { data: {
          year: selectedYear - 1,
          monthsArray: previousYearRainData}}"></ng-container>
  <ng-container *ngTemplateOutlet="yearContainer; context: { data: {
      year: selectedYear,
      monthsArray: yearRainData}}"></ng-container>
  <ng-container *ngTemplateOutlet="yearContainer; context: { data: {
      year: selectedYear + 1,
      monthsArray: nextYearRainData}}"></ng-container>
</div>

<div class="box comparation-year-graphic-container">
  <div class="header">Comparación por años</div>

  <div class="svg-wrapper" #svgComparationYearWrapper>
    <svg [attr.viewBox]="'0 0 ' + comparationYearSvgWidth + ' 325'" height="360"
      *ngIf="comparationYearRainData.length > 0">
      <!-- water lines -->
      <line *ngFor="let waterLine of comparationYearRainData; let i=index" [attr.x1]="30 + 30*i" y1="260"
        [attr.x2]="30 + 30*i" [attr.y2]="waterLine.svgOffset"
        [attr.stroke]="waterLine.date.getFullYear() === selectedYear ? '#c1c100' : '#00a2e8'" stroke-width="20"
        (click)="selectYear(waterLine.date.getFullYear())" style="cursor: pointer" />

      <!-- water liters -->
      <text *ngFor="let waterLine of comparationYearRainData; let i=index"
        [attr.text-anchor]="waterLine.svgOffset > 180 ? 'end' : 'start'"
        [attr.transform]="'rotate(90,'+(25 + 30*i)+','+waterLine.svgOffset+')'"
        [attr.x]="waterLine.svgOffset > 180 ? (15 + 30*i): (35 + 30*i)" [attr.y]="waterLine.svgOffset+1.5"
        [attr.fill]="waterLine.svgOffset > 180 ? '#00a2e8' : 'white'"
        [attr.fill]="waterLine.svgOffset > 200 ? waterLine.date.getFullYear() === selectedYear ? '#c1c100': '#00a2e8' : 'white'"
        stroke="none" font-size="1.1rem" (click)="selectYear(waterLine.date.getFullYear())" style="cursor: pointer">
        <ng-container *ngIf="!waterLine.isFake">{{waterLine.liters}} L</ng-container>
      </text>

      <!-- y axis -->
      <line x1="5" y1="0" x2="5" y2="260" stroke="black" stroke-width="5" />

      <!-- x axis -->
      <line x1="2.5" y1="260" [attr.x2]="comparationYearSvgWidth" y2="260" stroke="black" stroke-width="5" />

      <!-- year numbers -->
      <text [attr.x]="25 + 30*i" y="265" *ngFor="let year of comparationYearRainData; let i=index"
        [attr.transform]="'rotate(80,'+(20 + 30*i)+',265)'" font-size="0.9rem">{{year.date.getFullYear()}}</text>
    </svg>
  </div>

  <p *ngIf="comparationYearRainData.length === 0" class="no-data-available">
    No hay datos disponibles sobre lluvia
  </p>
</div>

<div class="pop-up-wrapper" *ngIf="popUp.show">
  <div class="content">
    <div>{{popUp.content}}</div>
    <button (click)="popUp.show = false">Cerrar</button>
  </div>
</div>

<ng-template #monthContainer let-data="data">
  <div class="month-graphic-container">
    <div class="header">
      <span (click)="showPopUpForMonth(data.monthsArray, data.month)">
        <p class="month-and-year">
          <span class="badge" *ngIf="showBadgeForMonth(data.monthsArray, data.month)"></span>
          {{MONTHS[data.month]}} {{data.year}}
        </p>
        <p class="liters" *ngIf="isTotalAmountOfLitersAvailableForMonth(data.monthsArray, data.month)">
          {{totalAmountOfLitersInMonth(data.monthsArray, data.month)}} litros
        </p>
      </span>
      <span class="icon">{{getWeatherIcon(data.month)}}</span>
      <div class="change-month-buttons">
        <button (click)="showPreviousMonth()">&lt;</button>
        <button (click)="showNextMonth()">&gt;</button>
      </div>
    </div>

    <ol class="calendar">
      <li>L</li>
      <li>M</li>
      <li>X</li>
      <li>J</li>
      <li>V</li>
      <li>S</li>
      <li>D</li>

      <li *ngFor="let day of data.daysArray let i=index" (click)="showPopUpForDay(day)"
        [ngStyle]="i===0 ?{'grid-column-start': getFirstDayOfMonthWeekDayIndex(data.month, data.year)}:{}">
        <span class="badge" *ngIf="day.popUpContent !== undefined"></span>

        <svg class="pluviometer-svg" viewBox="0 0 300 360">
          <!-- the filter includes the water inside -->
          <filter [id]="'fillpartial'+day.date.getFullYear()+''+day.date.getMonth()+''+i">
            <feFlood flood-color="#00a2e8" />
            <feOffset [attr.dy]="day.svgOffset"></feOffset>
            <feComposite operator="in" in2="SourceGraphic" />
            <feComposite operator="over" in2="SourceGraphic" />
          </filter>

          <!-- border and background -->
          <path
            d="M20,40C100,10 200,10 280,40L280,115C280,150 240,160 220,170L190,350L110,350L80,170C60,160 20,150 20,115Z"
            stroke="#b5e61d" stroke-width="40" />
          <path
            d="M20,40C100,10 200,10 280,40L280,115C280,150 240,160 220,170L190,345L110,345L80,170C60,160 20,150 20,115Z"
            stroke="none" fill="#e1ffe2"
            [attr.filter]="'url(#fillpartial'+day.date.getFullYear()+''+day.date.getMonth()+''+i+')'" />

          <!-- measure lines -->
          <path d="M86,200C 138,202 146,202, 161,200" [attr.stroke]="[day.svgOffset > 216 ? '#757575' : '#FFF']"
            stroke-width="9" fill="none" />
          <path d="M92,240C 138,242 146,242, 164,240" [attr.stroke]="[day.svgOffset > 257 ? '#757575' : '#FFF']"
            stroke-width="9" fill="none" />
          <path d="M99,280C 138,282 146,282, 167,280" [attr.stroke]="[day.svgOffset > 292 ? '#757575' : '#FFF']"
            stroke-width="9" fill="none" />
          <path d="M106,320C 138,322 146,322, 170,320" [attr.stroke]="[day.svgOffset > 335 ? '#757575' : '#FFF']"
            stroke-width="9" fill="none" />

          <!-- day number -->
          <text x="150" y="140" stroke="#e1ffe2" stroke-width="15" fill="#1c9a00" font-size="8.5rem"
            paint-order="stroke" text-anchor="middle">{{i+1}}</text>
        </svg>

        <span class="liters" *ngIf="!day.isFake">{{day.liters}} L</span>
      </li>
    </ol>

    <p *ngIf="!isDataAvailableForEachDayOfMonth(data.daysArray)" class="no-data-available">
      No hay datos disponibles por día
    </p>
  </div>
</ng-template>

<ng-template #yearContainer let-data="data">
  <div class="year-graphic-container">
    <div class="header">
      <button (click)="showPreviousYear()">&lt;</button>
      <span>
        <p class="year">Meses {{data.year}}</p>
        <p class="liters" *ngIf="isTotalAmountOfLitersAvailableForYear(data.monthsArray)">
          {{getTotalAmountOfLitersInYear(data.monthsArray)}} litros
        </p>
      </span>
      <button (click)="showNextYear()">&gt;</button>
    </div>

    <svg viewBox="0 0 400 300" *ngIf="isDataAvailableForYear(data.monthsArray)">
      <!-- water lines -->
      <line *ngFor="let waterLine of data.monthsArray; let i=index" class="water-year-line" [attr.x1]="30 + 30*i"
        y1="260" [attr.x2]="30 + 30*i" [attr.y2]="waterLine.svgOffset"
        [attr.stroke]="i===selectedMonth ? '#c1c100' : '#00a2e8'" stroke-width="20"
        (click)="selectMonthOfSelectedYear(i)" />

      <!-- water liters -->
      <text *ngFor="let waterLine of data.monthsArray; let i=index" (click)="selectMonthOfSelectedYear(i)"
        [attr.text-anchor]="waterLine.svgOffset > 200 ? 'end' : 'start'"
        [attr.transform]="'rotate(90,'+(25 + 30*i)+','+waterLine.svgOffset+')'"
        [attr.x]="waterLine.svgOffset > 200 ? (15 + 30*i): (35 + 30*i)" [attr.y]="waterLine.svgOffset +2"
        [attr.fill]="waterLine.svgOffset > 200 ? i===selectedMonth ? '#c1c100': '#00a2e8' : 'white'" stroke="none"
        font-size="1.2rem" style="cursor: pointer">
        <ng-container *ngIf="!waterLine.isFake">{{waterLine.liters}} L</ng-container>
      </text>

      <!-- y axis -->
      <line x1="5" y1="0" x2="5" y2="260" stroke="black" stroke-width="5" />

      <!-- x axis -->
      <line x1="2.5" y1="260" x2="390" y2="260" stroke="black" stroke-width="5" />

      <!-- month initial letters -->
      <text [attr.x]="25 + 30*i" y="290" *ngFor="let month of MONTHS; let i=index">{{month[0]}}</text>
    </svg>

    <p *ngIf="!isDataAvailableForYear(data.monthsArray)" class="no-data-available">
      No hay datos disponibles para este año
    </p>
  </div>
</ng-template>