<app-header-print [data]="headerPrintData"></app-header-print>

<main>
  <h1 class="title">SQL</h1>

  <section>
    <h2>Introducción</h2>

    <p>
      Para empezar, SQL son las siglas de <strong>Structured Query Language</strong>, que en español significa
      <i>Lenguaje de consultas estructurado</i>. Es un lenguaje y sirve para realizar consultas a bases de datos
      relacionales. Resumiéndolo mucho una base de datos relacional son varias tablas relacionadas entre sí, con sus
      filas y sus columnas.
    </p>

    <p>
      Este lenguaje es un estándar, por lo que pueden existir diferentes implementaciones o también llamados dialectos
      que pueden diferir entre sí con elementos que no están en el estándar. Ejemplos son las implementaciones de
      Oracle, Microsoft, MySQL o PostgreSQL.
    </p>

    <p>
      Como todo lenguaje tiene su sintaxis y sus palabras reservadas, y es lo que vamos a ver a continuación. Vamos
      derecho a ello.
    </p>
  </section>

  <section>
    <h2>Entorno</h2>

    <p>
      Para poder practicar necesitamos tener algún programa instalado que nos permita crear bases de datos y realizar
      consultas. En mi caso voy a usar MySql, que es un sistema de gestión de bases de datos relacional con licencia
      dual, es decir, tiene una parte libre y otra comercial. Si tienes curiosidad investiga lo que significa, yo
      tampoco lo sabía.
    </p>

    <p>
      Como sistema operativo usaré Ubuntu. Es muy sencillo de instalar, así que por aquí dejo los comandos. Por cierto,
      lo he hecho como usuario root.
    </p>

    <app-terminal-code>
      <p terminal-code-command>apt-get update</p>
      <p terminal-code-command>apt-get install mysql-server</p>
      <p terminal-code-command>mysql --version</p>
      <p terminal-code-output>mysql Ver 8.0.32-0ubuntu0.20.04.2 for Linux on x86_64 ((Ubuntu))</p>
    </app-terminal-code>

    <p>Estando instalado, para conectarnos con una terminal donde aprender sql tenemos este comando:</p>

    <app-terminal-code>
      <p terminal-code-command>
        mysql -h &lt;dominio-o-direccionIP&gt; -u &lt;usuario&gt; -p&lt;password&gt;
        &lt;nombreBaseDeDatos&gt;
      </p>
    </app-terminal-code>

    <p>
      En mi caso el dominio es localhost, así que lo omito. Fíjate que la contraseña tiene que ir pegada al parámetro
      -p. Si pones un espacio no te la tomará y te pedirá la contraseña al pulsar intro. El nombre de la base de datos
      también es opcional. Como aún no tenemos ninguna, no lo pongo.
    </p>

    <app-terminal-code>
      <p terminal-code-command>mysql -u root -p</p>
      <p terminal-code-output>Enter password:</p>
      <p terminal-code-output>mysql></p>
    </app-terminal-code>
  </section>

  <section>
    <h2>Crear una base de datos</h2>

    <p>
      Para empezar a trabajar lo primero que tenemos que tener o crear es la base de datos. En este artículo vamos a
      crear una base de datos para un negocio fiction de coches. Esto es sencillo de hacer:
    </p>

    <app-terminal-code>
      <p terminal-code-command>create database business;</p>
      <p terminal-code-output>Query OK, 1 row affected (0,00 sec)</p>
    </app-terminal-code>

    <p>
      Ya esta creada la base de datos. La he llamado <i>business</i>. Lo único que no tiene tablas ni información.
      Podemos ver las bases de datos que tenemos con:
    </p>

    <app-terminal-code>
      <p terminal-code-command>show databases;</p>
      <pre terminal-code-output>+--------------------+
| Database           |
+--------------------+
| business           |
| information_schema |
| mysql              |
| performance_schema |
| sys                |
+--------------------+
5 rows in set (0,00 sec)</pre>
    </app-terminal-code>

    <p>
      Vemos que nuestra base de datos está ahí. Las otras son cosas del servidor y contienen metainformación. Mejor no
      tocarlas.
    </p>

    <p>
      Para trabajar con la base de datos creada, la debemos seleccionar. De esta forma los comandos que escribamos irán
      por defecto dirigidos a ella.
    </p>

    <app-terminal-code>
      <p terminal-code-command>use business;</p>
      <p terminal-code-output>Database changed</p>
    </app-terminal-code>
  </section>

  <section>
    <h2>Crear tablas</h2>

    <p>
      Una base de datos sin información no vale para nada. Y la información se guarda en tablas. Así que vamos a ver
      como crearlas.
    </p>

    <code>
      <pre class="command-sintax">CREATE TABLE nombreTabla (
  nombreColumna 
    tipo
    [NOT NULL]
    [DEFAULT valorPorDefecto]
    [UNIQUE] [PRIMARY_KEY] [REFERENCES tabla (columna)] [CHECK (expresiónBooleana)],
  [UNIQUE (columna, columna, ...)],
  [PRIMARY_KEY (columna, columna, ...)],
  [FOREING_KEY (columna, columna, ...) REFERENCES tabla (columna, columna, ...)],
  [CHECK (expresiónBooleana)]
);</pre>
    </code>

    <p>
      Esta sentencia creará una tabla en la base de datos seleccionada. El propietario de la tabla será el usuario que
      la crea, es decir, el usuario que usaste para loguearte en el Sitema Gestor de Bases de Datos (SGBD).
    </p>

    <p>
      Lo que tenemos son dos secciones: definición de columnas de la tabla, y definición de reglas de integridad para la
      tabla entera. Cada columna o restricción de tabla va separada por una coma.
    </p>

    <p>
      Lo imprescindible para definir una columna es el nombre y su tipo. El nombre lo eliges tú y el tipo puede
      depender del SGBD. Estos son algunos de los habituales: VARCHAR, DATE, INTEGER, FLOAT. Consulta el manual del SGBD
      para más información.
    </p>

    <p>
      Además del nombre y el tipo podemos opcionalmente poner restricciones, como si la columna puede tener valores
      vacíos o ponerle valores por defecto si no los indicamos al meter datos.
    </p>

    <p>
      Toda tabla tiene una PRIMARY_KEY, que quiere decir que los valores de esa columna no se repiten para ninguna fila.
      Con UNIQUE podemos decirle lo mismo, pero sin que sea la PRIMARY_KEY oficial.
    </p>

    <p>
      Con REFERENCES podemos decir que el valor de la columna tendrá que ser un valor que coincida con alguno de otra
      columna en otra tabla. De esta forma indicamos una FOREIGN_KEY.
    </p>

    <p>
      Por último con CHECK podemos hacer validaciones sobre el valor. Por ejemplo, si es una edad lo que vamos a guardar
      en la columna podemos comprobar que sea mayor que cero antes de introducir datos en la tabla.
    </p>

    <p>
      La segunda sección serían las restricciones de la tabla. En caso que queramos poner restricciones que impliquen a
      varias columnas podemos decirlo aquí.
    </p>

    <p>
      Ahora que conocemos la sintaxis vamos a crear las tablas de nuestra base de datos. Este será el esquema:
    </p>

    <img class="bbdd-scheme-image" src="pages-bbdd/assets/bbdd-scheme.png" alt="Esquema base de datos">

    <p>
      Despliega los elementos para ver la orden que crea las tablas:
    </p>

    <div class="collapsible">
      <p class="collapsible__title"
        (click)="collapsedTables.createTableMechanic = !collapsedTables.createTableMechanic">
        MECANICO
      </p>

      <app-terminal-code [ngClass]="{'app-terminal-code--expanded': !collapsedTables.createTableMechanic}">
        <pre terminal-code-command>CREATE TABLE MECANICO (
  codigo integer not null primary key,
  nombre varchar(50),
  ciudad varchar(50)
);</pre>

        <span terminal-code-output>Query OK, 0 rows affected (0,02 sec)</span>
      </app-terminal-code>
    </div>

    <div class="collapsible">
      <p class="collapsible__title" (click)="collapsedTables.createTableBrand = !collapsedTables.createTableBrand">
        MARCA
      </p>

      <app-terminal-code [ngClass]="{'app-terminal-code--expanded': !collapsedTables.createTableBrand}">
        <pre terminal-code-command>CREATE TABLE MARCA (
  codigo integer not null primary key, 
  nombre varchar(20),
  sede varchar(20)
);</pre>

        <span terminal-code-output>Query OK, 0 rows affected (0,01 sec)</span>
      </app-terminal-code>
    </div>

    <div class="collapsible">
      <p class="collapsible__title"
        (click)="collapsedTables.createTableConcessionaire = !collapsedTables.createTableConcessionaire">
        CONCESIONARIO
      </p>

      <app-terminal-code [ngClass]="{'app-terminal-code--expanded': !collapsedTables.createTableConcessionaire}">
        <pre terminal-code-command>CREATE TABLE CONCESIONARIO (
  codigo integer not null primary key, 
  localidad varchar(50),
  hora_apertura varchar(50),
  hora_cierre varchar(50)
);</pre>

        <span terminal-code-output>Query OK, 0 rows affected (0,03 sec)</span>
      </app-terminal-code>
    </div>

    <div class="collapsible">
      <p class="collapsible__title" (click)="collapsedTables.createTableCar = !collapsedTables.createTableCar">
        COCHE
      </p>

      <app-terminal-code [ngClass]="{'app-terminal-code--expanded': !collapsedTables.createTableCar}">
        <pre terminal-code-command>CREATE TABLE COCHE (
  codigo integer not null primary key,
  cod_marca integer not null references marca,
  modelo varchar(60) not null,
  propulsion varchar(60) not null
);</pre>

        <span terminal-code-output>Query OK, 0 rows affected (0,02 sec)</span>
      </app-terminal-code>
    </div>

    <div class="collapsible">
      <p class="collapsible__title" (click)="collapsedTables.createTableRepair = !collapsedTables.createTableRepair">
        REPARA
      </p>

      <app-terminal-code [ngClass]="{'app-terminal-code--expanded': !collapsedTables.createTableRepair}">
        <pre terminal-code-command>CREATE TABLE REPARA (
  cod_mecanico integer not null references mecanico, 
  cod_coche integer not null references coche,
  fecha varchar(20),
  precio integer check(precio > 0),
  primary key (cod_mecanico, cod_coche)
);</pre>

        <span terminal-code-output>Query OK, 0 rows affected (0,01 sec)</span>
      </app-terminal-code>
    </div>

    <div class="collapsible">
      <p class="collapsible__title" (click)="collapsedTables.createTableOffer = !collapsedTables.createTableOffer">
        OFRECE
      </p>

      <app-terminal-code [ngClass]="{'app-terminal-code--expanded': !collapsedTables.createTableOffer}">
        <pre terminal-code-command>CREATE TABLE OFRECE (
  cod_coche integer not null references coche,
  cod_concesionario integer not null references concesionario,
  cantidad integer,
  primary key (cod_coche, cod_concesionario)
);</pre>

        <span terminal-code-output>Query OK, 0 rows affected (0,02 sec)</span>
      </app-terminal-code>
    </div>

    <div class="collapsible">
      <p class="collapsible__title" (click)="collapsedTables.createTableClient = !collapsedTables.createTableClient">
        CLIENTE
      </p>

      <app-terminal-code [ngClass]="{'app-terminal-code--expanded': !collapsedTables.createTableClient}">
        <pre terminal-code-command>CREATE TABLE CLIENTE (
  dni varchar(15) not null primary key,
  nombre varchar(40) not null,
  fecha_nac varchar(40),
  telefono varchar(15)
);</pre>

        <span terminal-code-output>Query OK, 0 rows affected (0,01 sec)</span>
      </app-terminal-code>
    </div>

    <div class="collapsible">
      <p class="collapsible__title" (click)="collapsedTables.createTableSale = !collapsedTables.createTableSale">
        VENTA
      </p>

      <app-terminal-code [ngClass]="{'app-terminal-code--expanded': !collapsedTables.createTableSale}">
        <pre terminal-code-command>CREATE TABLE VENTA (
  num_factura varchar(15) not null primary key,
  cod_cliente varchar(15) not null references cliente(dni),
  cod_coche integer,
  cod_concesionario integer,
  precio integer check(precio > 100),
  fecha varchar(30) not null,
  foreign key (cod_coche, cod_concesionario) references OFRECE(cod_coche, cod_concesionario)
);</pre>

        <span terminal-code-output>Query OK, 0 rows affected (0,02 sec)</span>
      </app-terminal-code>
    </div>
  </section>

  <section>
    <h2>Alteración de tablas</h2>

    <p>
      A medida que vamos usando la base de datos y los requisitos de nuestra aplicación varian, puede que tengamos que
      cambiar restricciones, referencias, eliminar o añadir nuevas columnas, etc. Y eso es lo que vamos a ver antes de
      rellenar la base de datos por si te equivocaste al crear una de las tablas.
    </p>

    <p>
      Veamos como eliminar una tabla. Ten en cuenta que solo se podrá eliminar si no está referenciada por ninguna otra
      tabla u objeto en la base de datos.
    </p>

    <code>
      <pre class="command-sintax">DROP TABLE nombre_de_la_tabla</pre>
    </code>

    <p>
      Ahora veamos como añadir o eliminar una columna de una tabla, o sus restricciones:
    </p>

    <code>
      <pre class="command-sintax">ALTER TABLE nombre_de_la_tabla
ADD especificación_de_una_columna
ADD [CONSTRAINT nombre_restricción] restricción_tabla
DROP CONSTRAINT nombre_restricción
DROP COLUMN nombre_columna [RESTRICT | CASCADE]</pre>
    </code>

    <p>
      Al eliminar una columna podemos indicar las opciones RESTRICT o CASCADE. Si indicamos RESTRICT la columna no se
      eliminará si es referenciada por otra tabla u objeto de la base de datos. Si indicamos CASCADE se eliminará la
      columna y todo lo que dependa de ella en otras tablas o lugares.
    </p>

    <p>
      Veamos un ejemplo para cambiar el tipo de una columna.
    </p>

    <app-terminal-code>
      <pre terminal-code-command>ALTER TABLE REPARA MODIFY fecha Date default (CURRENT_DATE);</pre>

      <pre terminal-code-output>Query OK, 0 rows affected (0,03 sec)
Records: 0  Duplicates: 0  Warnings: 0</pre>
    </app-terminal-code>

    <p>
      En test caso puesto que estamos modificando una columna existente y cambiando su tipo, usamos la palabra MODIFY.
      Después la sintaxis es la misma que ya hemos visto para definir una columna.
    </p>
  </section>











  <section>
    <h2>La sentencia SELECT</h2>

    <p>
      Esta es la sentencia básica para recuperar datos de una base de datos. El formato de una consulta con esta
      sentencia es:
    </p>

    <code>
      <pre class="command-sintax">SELECT [ALL | DISTINCT]
expresión
FROM tabla
WHERE condición
ORDER BY columna/nº columna [ASC | DESC]</pre>
    </code>

    <p>
      La salida del comando es otra tabla con tantas filas como filas de la tabla a consultar cumplan la condición y
      tantas columnas como expresiones indiquemos.
    </p>

    <p>
      Con la primera línea indicamos que vamos a seleccionar datos de la tabla. La opción ALL es por defecto y significa
      que seleccione todas las filas aunque estén repetidas. Si ponemos DISTINCT la tabla de salida solo tendrá filas
      que no están repetidas (se eliminan las que están duplicadas).
    </p>

    <p>
      La segunda línea es una expresión. Podemos poner varias separadas por comas. Consiste en el nombre de una columna
      de la tabla, o expresiones matemáticas, o llamadas a funciones que manejen datos de tipo fecha o numérico o
      string. Podemos hacer que se concatenen columnas en una sola, y muchas más cosas.
    </p>

    <p>
      Con FROM indicamos la tabla de la cual vamos a seleccionar datos.
    </p>

    <p>
      Con WHERE podemos indicar las condiciones para seleccionar filas de la tabla. Podemos usar operadores lógicos
      (AND, OR y NOT), de comparación (=, &lt;&gt;, &lt;, &lt;=, &gt;,&gt;=) o predicados más avanzados (IN, BETWEEN,
      LIKE, IS NULL)
    </p>

    <p>
      Con ORDER BY podemos ordenar las filas de la tabla resultante de forma ascendente o descendente. Podemos hacerlo
      indicando el índice de una columna o su nombre. El nombre de la columna es el de la tabla original, o si es una
      columna compuesta (una expresión más compleja) podemos poner AS en la expresión para ponerle un nombre a la
      columna resultante.
    </p>

    <p>
      Veámosla en uso. Supongamos que tenemos la siguiente tabla (llamada <i>Car</i>) con información sobre coches:
    </p>

    <div class="car-table">
      <table>
        <thead>
          <tr>
            <td>ID</td>
            <td>MARCA</td>
            <td>NOMBRE</td>
            <td>MATRICULA</td>
            <td>COMBUSTIBLE</td>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let car of carsTable">
            <td>{{car.id}}</td>
            <td>{{car.brand}}</td>
            <td>{{car.name}}</td>
            <td>{{car.registration}}</td>
            <td>{{car.propulsion}}</td>
          </tr>
        </tbody>
      </table>
    </div>

    <p>
      Ahora vamos a realizar algunas consultas. Por ejemplo, busquemos los coches que su combustible es diésel. La
      consulta y el resultado serían estos:
    </p>

    <code class="comand-example">
      <div>
        <pre><span class="command">SELECT * FROM Car WHERE COMBUSTIBLE="Diésel";</span>
+----+---------+--------+-----------+-------------+
| ID | MARCA   | NOMBRE | MATRICULA | COMBUSTIBLE |
+----+---------+--------+-----------+-------------+
|  0 | Renault | Megane | 0012TER   | Diésel      |
|  1 | Seat    | León   | 8435POM   | Diésel      |
|  3 | Ford    | Focus  | 1493UGF   | Diésel      |
|  6 | Seat    | Arona  | 7591MIN   | Diésel      |
|  8 | Audi    | A3     | 1254UNR   | Diésel      |
+----+---------+--------+-----------+-------------+</pre>
      </div>
    </code>

    <!-- TODO continue with more examples -->
  </section>
</main>