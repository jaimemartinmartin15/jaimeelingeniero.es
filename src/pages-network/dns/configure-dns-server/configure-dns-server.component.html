<app-header-print [data]="headerPrintData"></app-header-print>

<main>
  <h1 class="title">Configuraci√≥n de un servidor DNS</h1>

  <section>
    <h2>Introducci√≥n</h2>

    <p>
      En este art√≠culo voy a explicar como configurar un servidor DNS. Y quiz√° te preguntes: ¬øpara qu√© necesito yo
      configurar un servidor DNS si ya existen cientos de servidores por todo el mundo que me permiten navegar por
      internet?
    </p>

    <p>
      Quiz√° tengas raz√≥n y no lo necesites, pero si eres desarrolador o te dedicas a este mundo te puede resultar √∫til
      para <strong>crear tus dominios o zonas locales</strong> a los que solo t√∫ tienes acceso en tu red. Ser√≠a una
      intranet privada. Podr√≠as poner nombres a todos tus dispositivos y estos no ser√≠an visibles en internet.
    </p>

    <p>
      Tambi√©n te permitir√≠a <strong>navegar m√°s r√°pido</strong>, pues el DNS puede cachear dominios reales y resolverlos
      en tu propia red, sin tener que acceder a internet para ello.
    </p>
  </section>

  <section>
    <h2>BIND</h2>

    <p>
      El programa por excelencia que act√∫a como servidor de nombres es <a href="https://www.isc.org/bind/"
        target="_blank" rel="noopener"><strong>BIND</strong></a>. Significa <i>Berkeley Internet Name Domain</i> y es el
      programa que usan la mayor√≠a de servidores DNS reales en todo el mundo.
    </p>

    <p>
      La organizaci√≥n <a href="https://www.isc.org/" target="_blank" rel="noopener">Internet Systems Consortium</a> es
      la encargada de su desarrollo, mantenimiento y actualizaciones. Es de <a
        href="https://github.com/isc-projects/bind9" target="_blank" rel="noopener">c√≥digo abierto</a> y su versi√≥n
      actual es la nueve, por lo que tambi√©n se le conoce como BIND9. El nombre del proceso que lo implementa es
      <strong>named</strong>.
    </p>

    <p>
      Vamos manos a la obra üë∑‚Äç‚ôÇÔ∏èüî®
    </p>
  </section>

  <section>
    <h2>Instalaci√≥n</h2>

    <p>
      Podr√≠amos empezar a usar BIND9 f√°cilmente usando su <a
        href="https://hub.docker.com/r/internetsystemsconsortium/bind9" target="_blank" rel="noopener">imagen de
        docker</a>, pero yo lo voy a instalar desde cero en una m√°quina virtual.
    </p>

    <p>
      Para ello ejecutamos lo siguiente:
    </p>

    <code>
      <div>
        <span class="command">apt update</span>
        <br>
        <span class="output">apt install bind9</span>
      </div>
    </code>

    <p>
      Una vez instalado pues ya est√°. Instalado y corriendo. Lo podemos comprobar ejecutando el siguiente comando:
    </p>

    <code>
      <div>
        <span class="command">systemctl is-active named</span>
        <br>
        <span class="output">active</span>
      </div>
    </code>

    <p>
      El comando deber√≠a sacar por pantalla que el servicio esta <i>active</i>.
    </p>
  </section>

  <section>
    <h2>Configuraci√≥n por defecto</h2>

    <p>
      Al instalar BIND se han creado una serie de ficheros de configuraci√≥n por defecto. Vamos a echarles un vistazo.
    </p>

    <h3 class="file-name">/etc/bind/named.conf</h3>

    <p>
      Este es el fichero de configuraci√≥n de BIND. Toda la configuraci√≥n se encuentra aqu√≠. Pero como podemos ver hay
      referencias a otros ficheros que tambi√©n forman parte de la configuraci√≥n. Esto permite separar cierta
      configuraci√≥n y la configuraci√≥n por zonas en diferentes ficheros, de forma que resulta m√°s f√°cil gestionarla.
    </p>

    <code>
      <div>
        <span class="command">cat /etc/bind/named.conf</span>
        <br>
        <div class="output">
          include "/etc/bind/named.conf.options"
          <br>
          include "/etc/bind/named.conf.local"
          <br>
          include "/etc/bind/named.conf.default-zones"
        </div>
      </div>
    </code>

    <h3 class="file-name">/etc/bind/named.conf.options</h3>

    <p>
      Este fichero contiene configuraci√≥n general para el servidor. Tiene un mogoll√≥n de opciones. Por defecto el
      fichero creado al instalar BIND9 se ve as√≠:
    </p>

    <code>
      <div>
        <span class="command">cat /etc/bind/named.conf.options</span>
        <br>
        <div class="output">
          options &#123;
          <br>
          &nbsp; &nbsp; directory "/var/cache/bind";
          <br>
          &nbsp; &nbsp; dnssec-validation auto;
          <br>
          &nbsp; &nbsp; listen-on-v6 &#123; any; &#125;;
          <br>
          &#125;;
        </div>
      </div>
    </code>

    <p>
      Por describir un poco lo que hay, <i>directory</i> indica el directorio de trabajo del servidor. Las rutas
      relativas que pongamos en los ficheros de configuraci√≥n ser√°n relativas a este directorio.
      <i>dnssec-validation</i> habilita DNSSEC, que son unas extensiones de seguridad. <i>listen-on-v6</i> especifica la
      direcci√≥n IPv6 en la que el servidor escuchar√° peticiones DNS.
    </p>

    <p>
      Si tienes curiosidad, puedes ver <a
        href="https://bind9.readthedocs.io/en/v9_18_7/reference.html#options-block-definition-and-usage" target="_blank"
        rel="noopener">todas las opciones</a> y que hace cada una.
    </p>

    <h3 class="file-name">/etc/bind/named.conf.local</h3>

    <p>
      Este fichero es el que nos permite definir nuestra configuraci√≥n local. Normalmente incluiremos otros ficheros con
      nuestros propios dominios.
    </p>

    <code>
      <div>
        <span class="command">cat /etc/bind/named.conf.local</span>
        <br>
        <span class="output">// Do any local configuration here</span>
      </div>
    </code>

    <h3 class="file-name">/etc/bind/named.conf.default-zones</h3>

    <p>
      Este fichero incluye configuraci√≥n de las zonas predeterminadas como la de loopback, broadcast y los servidores
      ra√≠ces.
    </p>

    <code>
      <div>
        <span class="command">cat /etc/bind/named.conf.default-zones</span>
        <br>
        <div class="output">
          zone "." &#123;
          <br>
          &nbsp; &nbsp; type hint;
          <br>
          &nbsp; &nbsp; file "/usr/share/dns/root.hints";
          <br>
          &#125;
          <br> <br>
          zone "localhost" &#123;
          <br>
          &nbsp; &nbsp; type master;
          <br>
          &nbsp; &nbsp; file "/etc/bind/db.local";
          <br>
          &#125;
          <br> <br>
          zone "127.in-addr.arpa" &#123;
          <br>
          &nbsp; &nbsp; type master;
          <br>
          &nbsp; &nbsp; file "/etc/bind/db.127";
          <br>
          &#125;
          <br> <br>
          zone "0.in-addr.arpa" &#123;
          <br>
          &nbsp; &nbsp; type master;
          <br>
          &nbsp; &nbsp; file "/etc/bind/db.0";
          <br>
          &#125;
          <br> <br>
          zone "255.in-addr.arpa" &#123;
          <br>
          &nbsp; &nbsp; type master;
          <br>
          &nbsp; &nbsp; file "/etc/bind/db.255";
          <br>
          &#125;
        </div>
      </div>
    </code>

    <p>
      Los servidores de nombres deben conocer las direcciones IP de los servidores DNS ra√≠z. Eso lo podemos encontrar en
      el fichero referenciado <span class="file-name">/usr/share/dns/root.hints</span>:
    </p>

    <code>
      <div>
        <span class="command">cat /usr/share/dns/root.hints</span>
        <br>
<pre class="output">
.                     3600000   NS     A.ROOT-SERVERS.NET.
A.ROOT-SERVERS.NET.   3600000   A      198.41.0.4
A.ROOT-SERVERS.NET.   3600000   AAAA   2001:503:ba3e::2:30
.                     3600000   NS     B.ROOT-SERVERS.NET.
B.ROOT-SERVERS.NET.   3600000   A      199.9.14.201
B.ROOT-SERVERS.NET.   3600000   AAAA   2001:500:200::b
...
</pre>
      </div>
    </code>

    <h3 class="file-name">/etc/bind/db.*</h3>

    <p>
      Estos ficheros son los ficheros de zona con los mapas de dominio. Nosotros tambi√©n crearemos los nuestros.
    </p>

    <code>
      <div>
        <span class="command">cat /etc/bind/db.local</span>
        <br>
<pre class="output">
$TTL   604800
@   IN   SOA   localhost. root.localhost. (
                2
                604800
                86400
                2419200
                604800 )
@   IN   NS     localhost.
@   IN   A      127.0.0.1
@   IN   AAAA   ::1
</pre>
      </div>
    </code>

    <p>
      En este ejemplo tenemos un total de cuatro RR. Para saber qu√© significan y cual es el formato puedes visitar el
      <a [routerLink]="['../']" fragment="rr-section">art√≠culo anterior</a>.
    </p>

    <p>
      El <strong>$TTL</strong> del inicio indica el tiempo de validez que tendr√°n por defecto los RR en las cach√©s.
    </p>

    <p>
      El <strong>@</strong> es el nombre de la zona. Para este caso, viene especificado en el fichero <span
        class="file-name">named.conf.default-zones</span> donde se declara la zona. En otro caso, ser√≠a el nombre del
      fichero sin el <i>db.</i>
    </p>
  </section>

  <section>
    <h2>Sintaxis de los ficheros de configuraci√≥n</h2>

    <p>
      Hay tres tipos de entidades que podemos usar en los ficheros de configuraci√≥n (no en los ficheros de zona):
    </p>

    <p>
      Los <strong>comentarios</strong> son simples anotaciones que podemos poner para hacer aclaraciones. Son ignorados
      por el programa y su √∫nica utilidad es dar informaci√≥n a otras personas que puedan leer o modificar la
      configuraci√≥n posteriormente. Hay tres tipos de comentarios:
      <span class="comment-sintax"><strong>/*</strong> comentario de varias l√≠neas <strong>*/</strong></span>
      <span class="comment-sintax"><strong>//</strong> comentario de una l√≠nea</span>
      <span class="comment-sintax"><strong>#</strong> comentario de una l√≠nea</span>
    </p>

    <p>
      Los <strong>bloques</strong> son contenedores que pueden incluir otros bloques o declaraciones. Algunos bloques no
      se pueden anidar, como el bloque <i>options</i> que hemos visto, y hay otros bloques que se pueden repetir, como
      el bloque <i>zone</i>, en cuyo caso hay que ponerles un nombre. El formato es el siguiente:
      <span class="block-sintax">
        nombreDelBloque parametro1 parametro2 ... &#123; declaraci√≥n1: valor; declaraci√≥n2: argumento valor; ...&#125;
      </span>
    </p>

    <p>
      Las <strong>declaraciones</strong> definen y controlan el comportamiento de BIND. Pueden tener un simple valor o
      m√∫ltiples en forma de nombre de par√°metro y valor. Algunas se pueden usar solo en unos bloques y otras se puden
      utilizar en varios bloques, perdiendo la declaraci√≥n que tiene √°mbito m√°s global.
    </p>
  </section>

  <section>
    <h2>Configurando una zona</h2>

    <p>
      Ahora vamos a crear un dominio para nuestra red, para los dispositivos de nuestra casa.
    </p>

    <p>
      En primer lugar copiaremos el fichero <span class="file-name">/etc/bind/db.local</span> y lo llamaremos <span
        class="file-name">/etc/bind/db.micasa</span>. Puede que tengas que usar la orden sudo. Tras editar el nuevo
      fichero se ver√° as√≠:
    </p>

    <code>
      <div>
        <span class="command">cp /etc/bind/db.local /etc/bind/db.micasa</span>
        <br>
        <span class="command">pico /etc/bind/db.micasa</span>
        <br>
        <span class="command">cat /etc/bind/db.micasa</span>
        <br>
<pre class="output">
 $TTL    604800
 @   IN   SOA   localhost. mi-correo.gmail.com. (
                              2
                              604800
                              86400
                              2419200
                              604800 )
 @                IN    NS    localhost.
 sobremesajaime   IN    A     192.168.1.55
 moviljaime       IN    A     192.168.1.54
 impresora        IN    A     192.168.1.42
</pre>
      </div>
    </code>

    <p>
      Para que BIND pueda ver este nuevo fichero, lo tenemos que poner en la configuraci√≥n. El fichero que tenemos que
      editar es <span class="file-name">/etc/bind/named.conf.local</span>. As√≠ se ve:
    </p>

    <code>
      <div>
        <span class="command">cat /etc/bind/named.conf.local</span>
        <br>
        <div class="output">
          zone "micasa" &#123;
          <br>
          &nbsp; &nbsp; type master;
          <br>
          &nbsp; &nbsp; file "/etc/bind/db.micasa";
          <br>
          &#125;;
        </div>
      </div>
    </code>

    <p>
      Por √∫ltimo lo que tenemos que hacer es recargar la cofiguraci√≥n de BIND:
    </p>

    <code>
      <div>
        <span class="command">service named reload</span>
      </div>
    </code>
  </section>

  <section>
    <h2>Configurando el cliente</h2>

    <p>
      Para usar el servidor DNS que hemos configurado, debemos editar las direcciones IP de los servidores DNS en las
      m√°quinas que queremos que usen nuestro servidor.
    </p>

    <p>
      Por ejemplo, en la propia m√°quina donde he instalado el servidor ser√≠a as√≠:
    </p>

    <img class="configure-dns-ubuntu-img" src="pages-network/dns/assets/configure-dns-ubuntu.png"
      alt="Configuraci√≥n DNS ubuntu">

    <p>
      Tambi√©n podr√≠amos editar el fichero <span class="file-name">/etc/resolv.conf</span>, pero al reiniciar la m√°quina
      la configuraci√≥n se borrar√≠a:
    </p>

    <code>
      <div>
        <span class="command">cat /etc/resolv.conf</span>
        <br>
        <div class="output">
          nameserver &lt;ip_de_la_m√°quina_donde_has_instalado_bind&gt;
          <br>
          # resto de l√≠neas
        </div>
      </div>
    </code>

    <p>
      Para editarlo en windows, es un poco m√°s complejo:
    </p>

    <img class="configure-dns-windows-img" src="pages-network/dns/assets/configure-dns-windows.png"
      alt="Configuraci√≥n DNS ubuntu">

    <p>
      A la izquierda tenemos la configuraci√≥n de windows, y a la derecha la m√°quina virtual donde est√° instalado el
      servidor DNS.
    </p>

    <p>
      Ya estar√≠a, ahora nuestras m√°quinas consultar√°n al servidor que hemos preparado.
    </p>
  </section>

  <section>
    <h2>√ìrdenes de diagn√≥stico</h2>

    <p>
      Vamos a probar ahora que lo que hemos configurado es correcto. Para ello necesitamos de unas herramientas que nos
      ayuden a verificarlo.
    </p>

    <h3>El comando dig</h3>

    <p>
      Vamos a probar este comando en la propia m√°quina donde est√° instalado el servidor. La sintaxis es esta de abajo.
      Los par√°metros entre corchetes son opcionales. El servidor al que preguntamos se precede con @.
    </p>

    <code>
      <div>
        <span class="command">dig [@&lt;ip_o_dominio_servidor_dns&gt;] &lt;nombre_de_dominio_a_resolver&gt; [&lt;tipo_de_registro&gt;]</span>
      </div>
    </code>

    Vamos probarlo de verdad:

    <code>
      <div>
        <span class="command">dig sobremesajaime.micasa | grep -v ';'</span>
        <br>
        <span class="output">sobremesajaime.micasa. 604800 IN A 192.168.1.55</span>
      </div>
    </code>

    <p>
      Bien! Funciona! Vemos que en la respuesta nos devuelve el registro A con la IP que configuramos en el archivo de
      zona. En este caso no hemos tenido que usar el par√°metro del servidor dns porque hab√≠amos configurado la m√°quina
      con la IP del servidor DNS en la secci√≥n anterior.
    </p>

    <h3>El comando nslookup</h3>

    <p>
      Para probar la configuraci√≥n en windows vamos a usar el comando nslookup:
    </p>

    <code>
      <div>
        <span class="command">nslookup sobremesajaime.micasa</span>
        <br>
        <div class="output">
          Servidor:  UnKnown
          <br>
          Address:  192.168.1.51
          <br>
          Nombre:  sobremesajaime.micasa
          <br>
          Address:  192.168.1.55
        </div>
      </div>
    </code>

    <p>
      Tambi√©n funciona! Genial. El servidor que nos responde es unknown porque no hemos configurado la resoluci√≥n
      inversa de su IP y por lo tanto no puede resolver <i>51.1.168.192.in-addr.arpa</i>.
    </p>
  </section>

  <p>
    Y esto es todo. Hemos visto un ejemplo de c√≥mo configurar un dominio casero. Habr√° decenas de cosas que puedas hacer
    tambi√©n aprendiendo toda la configuraci√≥n, pero eso ya queda de tu lado aprenderlo üë®‚Äçüéì
  </p>
</main>